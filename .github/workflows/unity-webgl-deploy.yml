name: Unity WebGL â†’ Deploy

on:
  push:
    branches: [ "Build" ]            # Build ë¸Œëœì¹˜ í‘¸ì‹œ ì‹œ ìë™ ì‹¤í–‰
  workflow_dispatch:                 # ìˆ˜ë™ ì‹¤í–‰ ì§€ì›
    inputs:
      deploy_target:
        description: "netlify | vercel | s3 | none"
        required: false
        default: "none"              # ê¸°ë³¸ none â†’ í† í° ì—†ì–´ë„ ë¹Œë“œë§Œ ìˆ˜í–‰

env:
  UNITY_VERSION: 6000.0.51f1         # â† í”„ë¡œì íŠ¸ Unity ë²„ì „ì— ë§ê²Œ ìˆ˜ì •
  PROJECT_PATH: .                    # â† Unity í”„ë¡œì íŠ¸ ë£¨íŠ¸
  BUILD_NAME: WebGL
  BUILDS_PATH: build                 # â† v4 ì…ë ¥ëª…: buildsPath (ê¸°ë³¸: build)

jobs:
  build-webgl:
    name: Build (WebGL)
    runs-on: ubuntu-latest
    steps:
      - name: Checkout (with LFS)
        uses: actions/checkout@v4
        with:
          lfs: true
          submodules: recursive

      - name: Cache Unity Library
        uses: actions/cache@v4
        with:
          path: ${{ env.PROJECT_PATH }}/Library
          key: Library-${{ env.BUILD_NAME }}-WebGL-${{ hashFiles('**/Packages/manifest.json') }}
          restore-keys: |
            Library-${{ env.BUILD_NAME }}-WebGL-
            Library-

      - name: Build WebGL
        uses: game-ci/unity-builder@v4
        env:
          # ğŸ”‘ Personal: ì´ë©”ì¼/ë¹„ë²ˆ + ULF ëª¨ë‘ í•„ìš” (ProëŠ” SERIAL)
          UNITY_EMAIL: ${{ secrets.UNITY_EMAIL }}
          UNITY_PASSWORD: ${{ secrets.UNITY_PASSWORD }}
          UNITY_LICENSE: ${{ secrets.UNITY_LICENSE }}
          # Pro/Plusì¼ ê²½ìš°:
          # UNITY_SERIAL: ${{ secrets.UNITY_SERIAL }}
        with:
          projectPath: ${{ env.PROJECT_PATH }}
          unityVersion: ${{ env.UNITY_VERSION }}
          targetPlatform: WebGL
          allowDirtyBuild: true
          buildName: ${{ env.BUILD_NAME }}     # ìµœì¢… í´ë”ëª…: build/WebGL
          buildsPath: ${{ env.BUILDS_PATH }}   # ì¶œë ¥ ë£¨íŠ¸: build

      - name: Upload artifact (WebGL folder contents)
        uses: actions/upload-artifact@v4
        with:
          name: webgl-build
          # í´ë” 'ë‚´ìš©ë¬¼'ë§Œ ì—…ë¡œë“œ â†’ dist ë°”ë¡œ ë°‘ì— index.html ì˜¤ë„ë¡
          path: ${{ env.BUILDS_PATH }}/${{ env.BUILD_NAME }}/
          if-no-files-found: error

  deploy:
    name: Deploy (${{ github.event.inputs.deploy_target || 'none' }})
    needs: build-webgl
    runs-on: ubuntu-latest
    # noneì´ë©´ ë°°í¬ ì¡ ìì²´ ìŠ¤í‚µ â†’ ë¹Œë“œë§Œ ì„±ê³µ
    if: ${{ (github.event.inputs.deploy_target || 'none') != 'none' }}

    # S3 OIDC ì‚¬ìš© ì‹œ í•„ìš”í•œ ê¶Œí•œ (Netlify/Vercelì—” ì˜í–¥ ì—†ìŒ)
    permissions:
      contents: read
      id-token: write

    env:
      DEPLOY_TARGET: ${{ github.event.inputs.deploy_target || 'none' }}

    steps:
      - name: Download artifact
        uses: actions/download-artifact@v4
        with:
          name: webgl-build
          path: dist

      # â”€â”€â”€â”€â”€â”€â”€â”€â”€ Netlify â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Install Netlify CLI
        if: env.DEPLOY_TARGET == 'netlify'
        run: npm i -g netlify-cli

      - name: Deploy to Netlify
        if: env.DEPLOY_TARGET == 'netlify'
        env:
          NETLIFY_AUTH_TOKEN: ${{ secrets.NETLIFY_AUTH_TOKEN }}
          NETLIFY_SITE_ID: ${{ secrets.NETLIFY_SITE_ID }}
        run: netlify deploy --dir=dist --prod --site "$NETLIFY_SITE_ID"

      # â”€â”€â”€â”€â”€â”€â”€â”€â”€ Vercel â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Install Vercel CLI
        if: env.DEPLOY_TARGET == 'vercel'
        run: npm i -g vercel

      - name: Deploy to Vercel
        if: env.DEPLOY_TARGET == 'vercel'
        env:
          VERCEL_TOKEN: ${{ secrets.VERCEL_TOKEN }}
          VERCEL_ORG_ID: ${{ secrets.VERCEL_ORG_ID }}
          VERCEL_PROJECT_ID: ${{ secrets.VERCEL_PROJECT_ID }}
        run: |
          vercel deploy dist --prod --token "$VERCEL_TOKEN" \
            --scope "$VERCEL_ORG_ID" --project "$VERCEL_PROJECT_ID"

      # â”€â”€â”€â”€â”€â”€â”€â”€â”€ S3 â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Configure AWS Credentials (OIDC)
        if: env.DEPLOY_TARGET == 's3'
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_TO_ASSUME }}
          aws-region: ${{ secrets.AWS_REGION }}

      - name: Sync to S3
        if: env.DEPLOY_TARGET == 's3'
        run: aws s3 sync dist "s3://${{ secrets.S3_BUCKET }}/" --delete
